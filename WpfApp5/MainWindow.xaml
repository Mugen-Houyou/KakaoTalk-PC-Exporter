<Window x:Class="KakaoPcLogger.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="KakaoTalk Capture Logger"
        Width="1004" Height="584"
        MinWidth="860" MinHeight="560"
        WindowStartupLocation="CenterScreen"
        Topmost="{Binding IsChecked, ElementName=ChkTopMost}">

    <Window.Resources>
        <Style x:Key="FieldLabel" TargetType="TextBlock">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,6,0"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>

        <Style x:Key="ReadonlyTextBox" TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="Background" Value="{DynamicResource {x:Static SystemColors.ControlLightBrushKey}}"/>
        </Style>

        <DataTemplate x:Key="ChatItemTemplate">
            <DockPanel LastChildFill="False">
                <CheckBox Margin="0,0,6,0"
                          IsChecked="{Binding IsSelected, Mode=TwoWay}"/>
                <StackPanel Orientation="Vertical">
                    <TextBlock Text="{Binding Title, Mode=OneWay}" FontWeight="SemiBold" />
                    <TextBlock FontSize="11" Foreground="Gray">
                        <Run Text="HWND:"/><Run Text="{Binding HwndHex, Mode=OneWay}"/>
                        <Run Text="  PID:"/><Run Text="{Binding Pid, Mode=OneWay}"/>
                        <Run Text="  클래스:"/><Run Text="{Binding ClassName, Mode=OneWay}"/>
                    </TextBlock>
                </StackPanel>
            </DockPanel>
        </DataTemplate>
    </Window.Resources>

    <DockPanel LastChildFill="True">

        <!-- 상단 툴바 -->

        <ToolBarTray DockPanel.Dock="Top">
            <ToolBar>
                <Button x:Name="BtnScan" Content="채팅방 검색" Width="100" Margin="0"
            ToolTip="현재 실행 중인 KakaoTalk.exe 창들에서 EVA_VH_ListControl_Dblclk 컨트롤을 검색합니다."/>
                <Separator/>

                <!-- 폴링(라운드로빈 간격) -->
                <TextBlock Text="폴링(ms):" Style="{StaticResource FieldLabel}"/>
                <TextBox x:Name="TxtIntervalMs" Width="50" Text="3000"
             ToolTip="캡처 주기(밀리초). 해당 주기마다 창을 번갈아가며 캡처합니다."/>

                <Separator/>

                <CheckBox x:Name="ChkRoundRobin" Content="라운드 로빈 순회" IsChecked="True" Margin="5,0"
              ToolTip="선택된 모든 채팅방을 순서대로 순회하며 캡처합니다. 해제 시, 좌측 메뉴에서 선택된 채팅방만 캡처합니다."/> 
                <CheckBox x:Name="ChkAutoInclude" Content="새 창을 자동 포함" Margin="8,0,0,0"
              ToolTip="검색 시 새로 열린 채팅방을 자동으로 선택 상태로 추가합니다."/>
                <CheckBox x:Name="ChkAutoScroll" Content="자동 스크롤" IsChecked="True" Margin="12,0,0,0"/>
                <CheckBox x:Name="ChkTopMost" Content="항상 위" Margin="8,0,0,0"/>

                <Separator/>

                <!-- FLASH 방식 제어 -->
                <TextBlock Text="FLASH:" Style="{StaticResource FieldLabel}" Margin="0,0,2,0"/>
                <Button x:Name="BtnStartFlash" Content="시작" Width="60" Margin="2,0"
            ToolTip="작업표시줄 FLASH/REDRAW 이벤트 기반 캡처 시작"/>
                <Button x:Name="BtnStopFlash" Content="중지" Width="60" Margin="2,0"
            ToolTip="FLASH 기반 캡처 중지" IsEnabled="False"/>

                <Separator/>

                <!-- 라운드 로빈 방식 제어 -->
                <TextBlock Text="RoundRobin:" Style="{StaticResource FieldLabel}" Margin="0,0,2,0"/>
                <Button x:Name="BtnStartRr" Content="시작" Width="60" Margin="2,0"
            ToolTip="타이머 기반 라운드로빈 캡처 시작"/>
                <Button x:Name="BtnStopRr" Content="중지" Width="60" Margin="2,0"
            ToolTip="라운드로빈 캡처 중지" IsEnabled="False"/>

                <Separator/>

            </ToolBar>
        </ToolBarTray>


        <!-- 메인 영역: 좌측 채팅방 목록 / 우측 로그 + 송신 컴포저 -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="360"/>
                <ColumnDefinition Width="8"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 좌측: 채팅방 리스트 -->
            <Border Grid.Column="0" Grid.Row="0" Margin="8"
                    BorderBrush="#DDD" BorderThickness="1">
                <DockPanel>
                    <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="8,8,8,4">
                        <TextBlock Text="발견된 채팅방" FontWeight="Bold" VerticalAlignment="Center"/>
                        <TextBlock Text=" (EVA_VH_ListControl_Dblclk)" Margin="4,0,0,0"
                                   Foreground="Gray" VerticalAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="8,0,8,6">
                        <CheckBox x:Name="ChkSelectAll" Content="전체 선택/해제" />
                        <TextBlock Text="   " />
                        <TextBlock Text="총 " />
                        <TextBlock x:Name="TxtChatCount" Text="0" FontWeight="Bold"/>
                        <TextBlock Text=" 개"/>
                    </StackPanel>

                    <ListView x:Name="LvChats"
                              ItemTemplate="{StaticResource ChatItemTemplate}"
                              SelectionMode="Extended"
                              Margin="8,0,8,8"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.ScrollUnit="Item"
                              ScrollViewer.CanContentScroll="True"/>
                </DockPanel>
            </Border>

            <!-- 가운데 구분자 -->
            <GridSplitter Grid.Column="1" Grid.RowSpan="2" Width="8" ResizeDirection="Columns"
                          HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ShowsPreview="True"/>

            <!-- 우측: 로그 + 송신 컴포저 -->
            <Grid Grid.Column="2" Grid.Row="0" Margin="8">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <!-- 캡처 로그 제목 -->
                    <RowDefinition Height="*"/>
                    <!-- 캡처 로그 내용 -->
                    <RowDefinition Height="Auto"/>
                    <!-- 송신 컴포저 -->
                </Grid.RowDefinitions>

                <!-- 로그 제목 -->
                <DockPanel Grid.Row="0" LastChildFill="False">
                    <TextBlock Text="캡처 로그" FontWeight="Bold" Margin="0,0,8,6"/>
                    <TextBlock Text=" |  " Margin="0,0,2,6" Foreground="Gray"/>
                    <TextBlock x:Name="TxtSendTarget" Margin="0,0,0,6" Foreground="Gray"
                               ToolTip="더블클릭한 채팅방(또는 현재 선택된 항목)이 송신 대상입니다."/>

                    <DockPanel DockPanel.Dock="Right" LastChildFill="False">
                        <Button x:Name="BtnClear" Content="로그 지우기" Margin="4,0" DockPanel.Dock="Right"/>
                        <Button x:Name="BtnCopyLog" Content="로그 복사" Margin="4,0" DockPanel.Dock="Right"/>
                    </DockPanel>
                </DockPanel>

                <!-- 로그 -->
                <Border Grid.Row="1" BorderBrush="#DDD" BorderThickness="1">
                    <ScrollViewer x:Name="LogScrollViewer" VerticalScrollBarVisibility="Auto">
                        <TextBox x:Name="TxtLog"
                                 Style="{StaticResource ReadonlyTextBox}"
                                 FontFamily="Cascadia Code, Consolas, 'D2Coding', monospace"
                                 FontSize="12.5"
                                 AcceptsReturn="True"
                                 AcceptsTab="True"
                                 TextWrapping="Wrap"
                                 VerticalScrollBarVisibility="Hidden"
                                 HorizontalScrollBarVisibility="Auto"
                                 Padding="8"/>
                    </ScrollViewer>
                </Border>

                <!-- ✅ 송신 컴포저 -->
                <Border Grid.Row="2" BorderBrush="#DDD" BorderThickness="1" Margin="0,8,0,0">
                    <!-- 좌: 메시지 입력, 우: 컨트롤 패널 -->
                    <Grid Margin="8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <!-- 입력창 -->
                            <ColumnDefinition Width="220"/>
                            <!-- 컨트롤 패널 너비 (필요시 조절) -->
                        </Grid.ColumnDefinitions>

                        <!-- 메시지 입력 -->
                        <TextBox x:Name="TxtComposer"
             Grid.Column="0"
             AcceptsReturn="True"
             TextWrapping="Wrap"
             VerticalScrollBarVisibility="Auto"
             HorizontalScrollBarVisibility="Disabled"
             FontFamily="Malgun Gothic, 'D2Coding', Consolas, monospace"
             FontSize="12"
             MinHeight="68"
             ToolTip="보낼 메시지를 입력하세요. Enter=전송, Ctrl+Enter=줄바꿈 (옵션 변경 가능)" Grid.ColumnSpan="2" Margin="0,0,167,0"/>

                        <!-- 우측 컨트롤 패널 -->
                        <Grid Grid.Column="1" Margin="58,0,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <!-- 버튼 -->
                                <RowDefinition Height="8"/>
                                <!-- 간격 -->
                                <RowDefinition Height="Auto"/>
                                <!-- 옵션 체크박스 -->
                                <RowDefinition Height="*"/>
                                <!-- 여백 -->
                                <RowDefinition Height="Auto"/>
                                <!-- 글자수 -->
                            </Grid.RowDefinitions>

                            <!-- 버튼 (가로) -->
                            <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button x:Name="BtnClearComposer" Content="지우기" Width="69" Margin="0,0,8,0"/>
                                <Button x:Name="BtnSend" Content="전송" Width="84"
                ToolTip="현재 선택/표시 중인 채팅방으로 메시지를 전송"/>
                            </StackPanel>

                            <!-- 옵션 (세로) -->
                            <StackPanel Grid.Row="2" Orientation="Vertical">
                                <CheckBox x:Name="ChkEnterToSend" Content="Enter=전송" IsChecked="True"
                  ToolTip="체크 시 Enter로 전송, Ctrl+Enter는 줄바꿈. 해제 시 Enter는 줄바꿈"/>
                                <CheckBox x:Name="ChkKeepFocusAfterSend" Content="전송 후 입력창을 유지" IsChecked="True"/>
                            </StackPanel>

                            <!-- 글자수 (우하단 정렬) -->
                            <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right">
                                <TextBlock Text="글자수:" VerticalAlignment="Center"/>
                                <TextBlock x:Name="TxtComposerCount" Text="0" FontWeight="Bold" Margin="4,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>

            </Grid>

            <!-- 하단 상태바 -->
            <StatusBar Grid.Row="1" Grid.ColumnSpan="3">
                <StatusBarItem>
                    <TextBlock x:Name="TxtStatus" Text="대기 중" ToolTip="현재 상태"/>
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock Text="캡처 건수:"/>
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock x:Name="TxtCount" Text="0"/>
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock Text="대상 채팅방:"/>
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock x:Name="TxtSelectedCount" Text="0"/>
                </StatusBarItem>
                <StatusBarItem HorizontalAlignment="Right">
                    <TextBlock x:Name="TxtTimestamp" Text="--:--:--"/>
                </StatusBarItem>
            </StatusBar>
        </Grid>
    </DockPanel>
</Window>
